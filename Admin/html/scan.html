<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/image/mfulogo.png">
    <title>MFU</title>
    <!-- ======= Styles ====== -->
    <link rel="stylesheet" href="/Admin/css/style.css">
</head>

<body>
    <!-- =============== Navigation ================ -->
    <div class="container">
        <div class="navigation">
            <ul>
                <li>
                    <a href="#">
                        <span class="icon">
                            <img src="/image/mfulogo.png" alt="MFU Logo" style="width: 50px; height: auto;">
                        </span>
                        <span class="title">Register for graduation</span>
                    </a>
                </li>

                <li>
                    <a href="/Admin/html/index.html">
                        <span class="icon">
                            <ion-icon name="home-outline"></ion-icon>
                        </span>
                        <span class="title">Dashboard</span>
                    </a>
                </li>

                <li>
                    <a href="/Admin/html/scan.html">
                        <span class="icon">
                            <ion-icon name="camera-outline"></ion-icon>
                        </span>
                        <span class="title">Scan</span>
                    </a>
                </li>

                <li>
                    <a href="/Admin/html/studentinfo.html">
                        <span class="icon">
                            <ion-icon name="people-outline"></ion-icon>
                        </span>
                        <span class="title">Student Info</span>
                    </a>
                </li>

                <li>
                    <a href="/Admin/html/report.html">
                        <span class="icon">
                            <ion-icon name="bookmark-outline"></ion-icon>
                        </span>
                        <span class="title">Report</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">
                            <ion-icon name="log-out-outline"></ion-icon>
                        </span>
                        <span class="title">Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- ========================= Main ==================== -->
        <div class="main">
            <div class="topbar">
                <div class="toggle">
                    <ion-icon name="menu-outline"></ion-icon>
                </div>
            </div>

            <!-- =============== Scan Face ================ -->
            <div class="cardBoxscan">
                <div class="card" onclick="scanFace()">
                    <div>
                        <div class="scanface">Scan</div>
                        <div class="cardName">click for scan</div>
                    </div>
                </div>
            </div>

            <!-- =============== Scan and Add Face ================ -->
            <div class="cardBoxscan">
                <div class="card" onclick="scanAndAddFace()">
                    <div>
                        <div class="scanface">Scan & Add</div>
                        <div class="cardName">Click to scan and add</div>
                    </div>
                </div>
            </div>


            <div id="student-info-box"
                style="display:none; position:fixed; top:50px; left:10px; background-color:#fff; padding:20px; box-shadow:0 0 10px rgba(0,0,0,0.1);">
                <h3>Student Info</h3>
                <p id="student-id"></p>
                <p id="student-name"></p>
                <p id="student-department"></p>
            </div>
        </div>
    </div>

    <!-- =========== Scripts =========  -->
    <script src="/js/node.js"></script>
    <script src="/js/main.js"></script>

    <!-- ====== ionicons ======= -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

    <!-- ====== face-api.js ======= -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

    <!-- ====== Custom Scripts ======= -->
    <script>

        async function scanFace() {
            const videoElement = document.createElement('video');
            videoElement.width = window.innerWidth;
            videoElement.height = window.innerHeight;
            videoElement.autoplay = true;
            videoElement.style.position = 'fixed';
            videoElement.style.left = '50%';
            videoElement.style.top = '50%';
            videoElement.style.transform = 'translate(-50%, -50%)';
            videoElement.style.zIndex = '1000';

            const closeButton = document.createElement('button');
            closeButton.innerText = 'Close';
            closeButton.style.position = 'fixed';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.zIndex = '1000';
            closeButton.style.padding = '10px 20px';
            closeButton.style.fontSize = '16px';
            closeButton.style.cursor = 'pointer';

            closeButton.onclick = () => {
                videoElement.srcObject.getTracks().forEach(track => track.stop()); // หยุดการใช้งานกล้อง
                document.body.removeChild(videoElement);
                document.body.removeChild(closeButton);
                document.getElementById('student-info-box').style.display = 'none'; // ซ่อน student info box
            };

            document.body.appendChild(videoElement);
            document.body.appendChild(closeButton);

            // เปิดใช้งานกล้อง
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;

            // โหลดโมเดล face-api.js
            await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
            await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('/models');

            const detections = await faceapi.detectAllFaces(videoElement, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();

            if (detections.length > 0) {
                const bestMatch = await getStudentInfo(detections[0].descriptor);
                if (bestMatch) {
                    document.getElementById('student-info-box').style.display = 'block';
                    document.getElementById('student-id').innerText = `ID: ${bestMatch.id}`;
                    document.getElementById('student-name').innerText = `Name: ${bestMatch.name}`;
                    document.getElementById('student-department').innerText = `Department: ${bestMatch.department}`;
                } else {
                    document.getElementById('student-info-box').style.display = 'block';
                    document.getElementById('student-id').innerText = `No data found`;
                    document.getElementById('student-name').innerText = ``;
                    document.getElementById('student-department').innerText = ``;
                }
            } else {
                alert('No face detected.');
            }
        }

        async function getStudentInfo(descriptor) {
            try {
                const response = await fetch('/recognize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ descriptor })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data; // คืนค่าข้อมูลนักเรียนที่เจอ
                } else {
                    return null; // ถ้าไม่พบข้อมูล
                }
            } catch (error) {
                console.error('Error fetching student info:', error);
                return null;
            }
        }
    </script>
    <script>
        async function scanAndAddFace() {
            const videoElement = document.createElement('video');
            videoElement.width = window.innerWidth;
            videoElement.height = window.innerHeight;
            videoElement.autoplay = true;
            videoElement.style.position = 'fixed';
            videoElement.style.left = '50%';
            videoElement.style.top = '50%';
            videoElement.style.transform = 'translate(-50%, -50%)';
            videoElement.style.zIndex = '1000';

            const closeButton = document.createElement('button');
            closeButton.innerText = 'Close';
            closeButton.style.position = 'fixed';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.zIndex = '1000';
            closeButton.style.padding = '10px 20px';
            closeButton.style.fontSize = '16px';
            closeButton.style.cursor = 'pointer';

            closeButton.onclick = () => {
                videoElement.srcObject.getTracks().forEach(track => track.stop()); // หยุดการใช้งานกล้อง
                document.body.removeChild(videoElement);
                document.body.removeChild(closeButton);
                document.getElementById('student-info-box').style.display = 'none'; // ซ่อน student info box
            };

            document.body.appendChild(videoElement);
            document.body.appendChild(closeButton);

            // เปิดใช้งานกล้อง
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;

            // โหลดโมเดล face-api.js
            await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
            await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('/models');

            // สร้างปุ่มสำหรับถ่ายรูป
            const captureButton = document.createElement('button');
            captureButton.innerText = 'Capture';
            captureButton.style.position = 'fixed';
            captureButton.style.bottom = '10px';
            captureButton.style.left = '10px';
            captureButton.style.zIndex = '1000';
            captureButton.style.padding = '10px 20px';
            captureButton.style.fontSize = '16px';
            captureButton.style.cursor = 'pointer';

            captureButton.onclick = async () => {
                const detections = await faceapi.detectAllFaces(videoElement, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();

                if (detections.length > 0) {
                    const descriptor = detections[0].descriptor;

                    // ถ่ายรูปและเก็บเป็น base64
                    const canvas = faceapi.createCanvasFromMedia(videoElement);
                    document.body.appendChild(canvas);
                    const imageDataUrl = canvas.toDataURL();

                    // แสดงฟอร์มสำหรับกรอกข้อมูล
                    const form = document.createElement('form');
                    form.innerHTML = `
                        <h3>Add Student Info</h3>
                        <label for="student-id">Student ID:</label><br>
                        <input type="text" id="student-id" name="student-id" required><br><br>
                        <label for="student-name">Name:</label><br>
                        <input type="text" id="student-name" name="student-name" required><br><br>
                        <label for="student-department">Department:</label><br>
                        <input type="text" id="student-department" name="student-department" required><br><br>
                        <input type="hidden" id="face-descriptor" name="face-descriptor" value='${JSON.stringify(Array.from(descriptor))}'>
                        <input type="hidden" id="image" name="image" value='${imageDataUrl}'>
                        <input type="submit" value="Add Student">
                    `;

                    document.body.appendChild(form);

                    form.onsubmit = async (event) => {
                        event.preventDefault();

                        const formData = new FormData(form);
                        const data = {
                            studentId: formData.get('student-id'),
                            name: formData.get('student-name'),
                            department: formData.get('student-department'),
                            faceDescriptor: JSON.parse(formData.get('face-descriptor')),
                            image: formData.get('image')
                        };

                        // ส่งข้อมูลไปยังเซิร์ฟเวอร์
                        try {
                            const response = await fetch('/addStudent', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(data)
                            });

                            if (response.ok) {
                                alert('Student added successfully!');
                            } else {
                                alert('Failed to add student.');
                            }
                        } catch (error) {
                            console.error('Error adding student:', error);
                            alert('Failed to add student.');
                        }
                    };
                } else {
                    alert('No face detected.');
                }
            };

            document.body.appendChild(captureButton);
        }
    </script>

</body>

</html>